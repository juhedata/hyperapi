部署一个API网关
==============

现在我们假设你是技术运维人员，或者是践行DevOps的开发人员，要负责企业内部的API服务的稳定运转，你需要了解有哪些API服务，运行在哪些服务器上，
每个API服务在被那些项目使用，


## 加入JuAPI

请查看 [用户与团队](user.md)


## 创建环境

环境是连接服务和网关的节点，对于API服务来说，环境代表着一个API网关或网关集群；对于一个API网关，环境代表着一组API服务，可以从环境获得相关的配置。

创建环境的表单需要以下内容：

* 命名空间： 环境可以选择在个人或者团队下创建，团队下的环境可以有多个管理员共同管理。
* 服务名称： API名称，因为这个名称需要在URL中使用，只允许使用字母，数字，-，_这些URL中允许的字符，
         在系统中一个服务的名称会表示为<命名空间>/<服务名称>
* 网关访问入口： 网关对外服务的入口地址，部署在这个环境的服务的访问地址将是：网关访问地址+服务路径。
* 环境描述： 介绍网关对应运维环境，和网关所运行的网络环境，

环境创建成功后，在环境信息页面可以找到导出网关配置YAML文件的链接，和API网关于JuAPI链接获得实时配置信息的WebSocket地址。


## 部署API网关

单机部署的场景，请参考[API网关安装](../gateway/installation.md)

对于生产环境，需要实现高可用的API网关部署，可以在按照上面的单机部署说明，在多个服务器上部署API网关，然后配合各种云平台的负载均衡服务实现HA的部署。
需要注意RateLimit之类有状态的过滤器是没有状态同步的，为了保证对客户端的有效频次限制，需要在负载均衡选择按照IP Hash的请求分配策略。


## 配置数据监控服务

API网关内置了Prometheus的监控数据采集接口和Loki日志数据采集接口，使用JuAPI云平台的用户需要保证云端的Prometheus服务可以访问到API网关的数据
采集接口地址，这样可以使用JuAPI系统中的数据监控功能。

对于内网部署的API网关，可以选择对接自有的Prometheus和Loki服务，或者通过pushgateway和promtail将监控数据中转到一个公网地址上。


## 管理服务部署

网关部署完成后，在JuAPI的环境配置页面，可以管理部署在环境上的API服务的开启和关闭。

