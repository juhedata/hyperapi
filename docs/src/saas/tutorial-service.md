发布一个API服务
==============

现在我们假设你是一名开发者，你和你的开发团队需要把一些功能（新开发的系统，或者老系统里的HTTP接口）以API的方式提供给其他团队，需要管理谁可以
使用你的API，每个使用者预计有多大的调用量（用来判断是否需要加服务器），每天的实际调用情况，API的响应速度...

JuAPI就是为了帮你解决这些问题而诞生的，你可以专注于API业务功能的开发，然后通过简单的几步设置将你的服务发布到JuAPI平台，技术能力的输出准备就绪。


## 加入JuAPI

请查看 [用户与团队](user.md)

## 创建API服务

创建API服务表单需要填写的内容：


* 命名空间： 服务可以选择在个人或者团队下创建，团队下的服务可以有多个管理员共同管理。
* 服务名称： API名称，因为这个名称需要在URL中使用，只允许使用字母，数字，-，_这些URL中允许的字符，
         在系统中一个服务的名称会表示为<命名空间>/<服务名称>
* 描述： 介绍API的文字
* APISpec地址（选填）： OAS格式的API定义文件的URL，用来显示API文档页，和服务器端客户端代码生成。**API定义是服务发布很重要的一部分，你的服务
        的用户需要这个文档才知道如何使用你的API服务。**
* 服务路径： 通过网关访问API时的路径前缀，例如一个服务的路径为"account"，网关入口为 https://api.gateway/，
        那么访问这个API服务的地址就是 https://api.gateway/account/
* 认证方式： 访问服务的APP可以使用的认证方式，关于认证方式选择详见[APP接口访问认证方式](tutorial-app.md#认证方式)
* 默认频次限制： 每个访问API服务的应用都要设置一个访问服务的频次限制，这个设置会创建一个用于对接试用的默认频次限制，后面可以在设置页添加SLA
* 部署环境（选填）： 服务需要部署到某个具体的环境（对应一个具体的API网关）上才能被应用访问到，这里需要选择一个环境来部署这个API服务。如果此时
        没有可用的环境，可以暂时留空，后面在设置页的服务部署设置中添加。
* 上游服务地址（选填）： API服务的后端实现地址，API网关会把请求中转到这些上游地址。因为不同环境的服务地址可能在不同的子网中，所以上游服务地址
        是与网关相关联的，如果上个选项选择了部署环境，则此项为必填。



## 设置过滤规则

API网关在数据包中转的过程中可以对请求和响应数据进行一些检查或者修改，目前支持一下三种过滤规则：

### RateLimit 访问频次限制

RateLimit过滤器可以限制一个服务被调用的次数，常用在SLA上限制应用的访问频次，而设置在服务上的频次限制一般是对上游服务负载能力的一个保护。

访问频次控制是通过TokenBucket算法实现的，限制单位时间内的最大访问次数，并允许积累一定的额度应付偶尔的高频次请求。设置的表单需要设置以下内容：

* 请求方法和请求路径正则表达式： 用来控制过滤器应用在特定的HTTP请求上
* 时间窗口： 计算访问次数的时间窗口，即单位时间所属的单位
* 频次限制： 单位时间内允许的访问次数
* 突发频次限制： 当访问次数没有达到频次限制时，剩余的次数可以积累下来应付偶尔的高频请求，这个设置代表可积累额度的上限。例如频次限制是100，
        突发频次限制是200，一个客户端正常的访问频次大约50，那么在某一个时间窗口中请求次数最高可以达到200，消耗掉之前结余的额度。
    
### Header 请求/响应头修改

Header过滤器可以修改请求和响应的header里的信息，可以通过修改请求头向后端服务传递一些信息，或者删掉响应头里的一些敏感信息。

创建Header过滤器的表单需要设置以下内容：

* 请求方法和请求路径正则表达式： 用来控制过滤器应用在特定的HTTP请求上
* 操作对象： 这个过滤器是修改请求，还是响应
* 插入字段： 要向header中添加的字段
* 删除字段： 要从header中删除的字段
    

### ACL 路径访问控制

ACL过滤器可以控制某些路径可以访问。有时需要将一个现有系统的某几个接口作为一个服务开放出来，可以利用路径访问控制将创建一个白名单，防止保留其他不想
开放的接口；或者需要隐藏个别接口地址，可以创建一个黑名单来隐藏地址。被ACL屏蔽的路径会返回404错误。

创建ACL过滤器的表单需要设置以下内容：

* 过滤器类型： 黑名单，白名单
* 请求方法和请求路径正则表达式（多行）： 描述过滤器应用于那些请求


## 添加SLA

上面提到的过滤规则是应用在**服务**上的，而有些过滤规则是应用在单个API用户上的，这种规则通过SLA来实现。API服务对每个**应用**的使用授权都指定了
一个SLA，这个应用在使用API服务是，SLA中设置的过滤规则会应用在请求和响应上。

最常见的过滤规则就是使用RateLimit控制每个应用的访问频次，一方面可以避免突发的高负载影响系统稳定，另一方面API服务的开发团队可以通过SLA的频次控制，
对服务的调用量有个大致的估计，可以相应的计划分配计算资源。使用ACL可以针对部分用户隐藏某些接口。

SLA可以在服务的设置页中管理，因为RateLimit是最常用的SLA规则，在创建SLA的表单中就会要求设置一下访问频次设置。SLA可以设置是否需要审核，控制APP
申请使用一个API服务时，选择不需要审核的SLA可以直接开始使用，而不需要等待服务管理员的审核。


## 服务部署

如果在前面的创建API服务中已经填写了部署环境和上游服务地址，那么你就已经完成了服务的部署，但还需要等待环境的管理员审核你的部署，通过审核之后就可以
通过环境对应的网关入口访问你的API服务了。

有哪些可用的部署环境，取决于你和所在的各个团队是否有人创建了环境和并部署了网关。如果没有，你也可以自己创建一个环境并安装一个网关，把服务部署到
自己的网关上。具体操作：[环境和网关管理](tutorial-gateway.md)

创建服务部署需要选择部署目标环境，并提供上游服务地址列表。对于环境的选择需要注意网关所在的网络环境是否能访问上游服务地址，可以查看环境的描述信息，
或联系网关管理员确认。
    
在服务部署页面还可以对上游服务的地址进行增删改，停用或启用某个上游服务地址。


## 管理Client

上一步其实就已经完成了API服务的发布了，服务发布之后，关注点就变成了服务的使用情况了。

在服务页面的Client标签里可以管理所有使用这个服务的应用，审核应用的调用申请，调整SLA，启用或停用Client。


## 监控API服务运行状况

在服务页面的Status标签中，可以查看从网关收集的API调用情况数据，包括API服务的每秒请求数，性能指标[Apdex](https://en.wikipedia.org/wiki/Apdex)，
各客户端APP端调用量，HTTP状态码分布。
